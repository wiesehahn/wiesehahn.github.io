---
title: Orthophoto coverage in Lower Saxony

#subtitle: 

description: |
  Get information about the coverage of LGLN products (othophotos / image based height models)

abstract: | 
  Orthoimagery in Lower Saxony is acquired on a regular basis by LGLN, for many applications the acquisition date is important. We use R to query and plot this information for orthophotos and derived height models. 

categories:
  - COG
  - Orthoimagery
  - Open Source
  - Raster Data
  - R

date: 2023-03-01
date-modified: last-modified
## `today` and `last-modified` will be rendered by quarto (e.g. date: today)

## author optional, default for all is set in metadata.yml
# author:
#  - name: Jens Wiesehahn
#    id: jw
#    orcid: 
#    email: wiesehahn.jens@gmail.com
## (https://quarto.org/docs/authoring/front-matter.html#affiliation)
#    affiliation: 
#      - name: NW-FVA
#        city: Göttingen
#        # state:
#        # url: 

site-url: https://wiesehahn.github.io/

image: ortho_coverage_by_month.jpeg
image-alt: |
  Orthoimage coverage by month

# copyright: 
#   holder: Wiesehahn, Jens
#   year: 2023

# toc: false

draft: false
---

<!--------------- post content ----------------->

## About LGLN opendata

The State Office for Geoinformation and Land Surveying Lower Saxony ([LGLN](https://www.lgln.niedersachsen.de/startseite/)) provides a lot of its geospatial data under open licences. And since some years they provide the data as Cloud Optimized GeoTIFFs (COG) and reference them via [SpatioTemporal Asset Catalogs (STAC)](https://stacspec.org/en). 
Here we access the data via R to explore it's coverage by acquisition date.

More information about the data under [opengeodata.lgln.niedersachsen.de](https://opengeodata.lgln.niedersachsen.de/#dop).


## Working with Orthoimagery

### Initialize metadata catalog

The index of available data is available as a geojson file which is stored in a cloud bucket. It consists of many polygons which cover Lower Saxony and represent image tiles (1 km² or 2 km²). For each tile it contains some basic metadata and links to further metadata of the images and links to the image data itself. 
We fetch the index file for orthoimages ([DOP](https://ni-lgln-opengeodata.hub.arcgis.com/apps/lgln-opengeodata::digitales-orthophoto-dop/about)) and image based height models ([bDOM](https://ni-lgln-opengeodata.hub.arcgis.com/apps/lgln-opengeodata::bildbasiertes-digitales-oberfl%C3%A4chenmodell-bdom20/about)) and plot information about acquisition dates. 

::: {.callout-note}
The data is also indexed in as STAC which allows for advanced searching, filtering and processing.
It can be e.g. explored via [Radiant Earth STAC-Browser](https://radiantearth.github.io/stac-browser/#/external/dop.stac.lgln.niedersachsen.de/collections/DOP).
:::


```{r}
#| echo: true
#| warning: false
#| message: false
#| error: false
#| code-fold: true
#| code-summary: "load libraries"
library(dplyr)
library(sf)
library(ggplot2)
```

```{r}
#| echo: true
#| code-fold: true
#| code-summary: "get data"

# read geojson from cloud bucket
get_data <- function(geojson){
  dat <- st_read(geojson) |> 
  # modify date
  mutate(
    date = lubridate::ymd(Aktualitaet),
    year = lubridate::year(date),
    month = lubridate::month(date, label = TRUE),
    doy = lubridate::yday(date)
  )
  return(dat)
}

dop20<- get_data("https://arcgis-geojson.s3.eu-de.cloud-object-storage.appdomain.cloud/dop20/lgln-opengeodata-dop20.geojson")
bdom20<- get_data("https://arcgis-geojson.s3.eu-de.cloud-object-storage.appdomain.cloud/bdom20/lgln-opengeodata-bdom20.geojson")
```


### Plot coverage by acquisitioin dates

The data catalog contains information about the acquisition date of images. We can plot this data to get more information about the available images. Acquisition dates for bDOM should be in principle the same as for DOP as the underlying image data is the same, however not all images were processed to bDOM as the necessary data quality (overlap) has not always been fulfilled.

#### Overview about acquisition dates
```{r}
#| echo: true
#| code-fold: true
#| code-summary: "get overview"

# first and last available acquisition dates
get_timespan <- function(dat){
  min <- dat|> arrange(date) |>  slice(1) |> pull(date)
  max <- dat|> arrange(desc(date)) |>  slice(1) |> pull(date)
  
  cat("Images available from", format(min), "to", format(max), "\n")
}

plot_distribution <- function(dat){
  dat |> 
  ggplot(aes(x = doy)) +
  geom_bar() +
  scale_x_continuous(
    breaks = c(1, 32, 60, 91, 121, 152, 182, 213, 244, 274, 305, 335),
    labels = month.abb,
    limits = c(1, 365)
  ) +
  labs(x = NULL, y = NULL) +
  theme_void() +
  theme(
    axis.text.x = element_text(),
    legend.position = "top"
  )
}

```

::: {.panel-tabset}
##### DOP
```{r}
#| echo: false
#| warning: false
#| fig-cap: Distribution of orthophoto acquisitions in Lower Saxony by Day of Year

get_timespan(dop20)

plot_distribution(dop20)
```

##### bDOM
```{r}
#| echo: false
#| fig-cap: Distribution of orthophoto acquisitions for height models in Lower Saxony by Day of Year

get_timespan(bdom20)

plot_distribution(bdom20)
```
:::

#### Most recent coverage
```{r}
#| echo: true
#| code-fold: true
#| code-summary: "plot latest data"

# latest acquisition date per tile
plot_latest <- function(dat){
  dat|> 
  group_by(tile_id) |> 
  slice_max(date, n = 1) |> 
  ggplot() + 
    geom_sf(aes(fill = as.factor(year)), color = NA) + 
    theme_void()  +
    scale_fill_viridis_d(option = "plasma", name = "Year")
}
```

::: {.panel-tabset}
##### DOP
```{r}
#| echo: false
#| fig-cap: Most recent available orthophoto coverage in Lower Saxony

plot_latest(dop20)
```

##### bDOM
```{r}
#| echo: false
#| fig-cap: Most recent available image based height model coverage in Lower Saxony

plot_latest(bdom20)
```
:::



#### First coverage

```{r}
#| echo: true
#| code-fold: true
#| code-summary: "plot first data"


# first acquisition date per tile
plot_first <- function(dat){
  dat|> 
  group_by(tile_id) |> 
  slice_min(date, n = 1) |> 
  ggplot() + 
    geom_sf(aes(fill = as.factor(year)), color = NA) + 
    theme_void()  +
    scale_fill_viridis_d(option = "plasma", name = "Year")
}
```

::: {.panel-tabset}
##### DOP
```{r}
#| echo: false
#| fig-cap: First available orthophoto coverage in Lower Saxony

plot_first(dop20)
```

##### bDOM
```{r}
#| echo: false
#| fig-cap: First available coverage of image based height model in Lower Saxony

plot_first(bdom20)
```
:::

#### Leaf-off coverage

```{r}
#| echo: true
#| code-fold: true
#| code-summary: "plot leaf-off data"

# latest leaf-off data per tile
plot_leafoff <- function(dat){
  dat|>  
  mutate(Year = if_else(!between(doy, 115, 315), 
                        as.character(year), 
                        NA_character_)) |> 
  arrange(!is.na(Year), date) |> 
  ggplot() + 
    geom_sf(aes(fill = Year), color = NA) + 
    theme_void() +
    scale_fill_viridis_d(option = "plasma", na.value = "#f2f2f2", name = "Year")
}

```

::: {.panel-tabset}
##### DOP
```{r}
#| echo: false
#| fig-cap: Available orthophoto coverage in Lower Saxony during leaf-off season (mid November - mid April)

plot_leafoff(dop20)
```

##### bDOM
```{r}
#| echo: false
#| fig-cap: Available coverage of image based height model in Lower Saxony during leaf-off season (mid November - mid April)

plot_leafoff(bdom20)
```
:::

#### Leaf-on coverage

```{r}
#| echo: true
#| code-fold: true
#| code-summary: "plot leaf-on data"

# latest leaf-on data per tile
plot_leafon <- function(dat){
  dat|>
  mutate(Year = if_else(between(doy, 115, 315), 
                        as.character(year), 
                        NA_character_)) |> 
  arrange(!is.na(Year), date) |> 
  ggplot() + 
    geom_sf(aes(fill = Year), color = NA) + 
    theme_void() +
    scale_fill_viridis_d(option = "plasma", na.value = "#f2f2f2", name = "Year")
}

```

::: {.panel-tabset}
##### DOP
```{r}
#| echo: false
#| fig-cap: Available orthophoto coverage in Lower Saxony during leaf-on season (mid April - mid November)

plot_leafon(dop20)
```

##### bDOM
```{r}
#| echo: false
#| fig-cap: Available coverage of image based height model in Lower Saxony during leaf-on season (mid April - mid November)

plot_leafon(bdom20)
```
:::

#### Acquisition month

```{r}
#| echo: true
#| code-fold: true
#| code-summary: "plot month"

# month of latest data per tile
plot_month <- function(dat){
  dat|>  
  group_by(tile_id) |> 
  slice_max(date, n = 1) |> 
  ggplot() + 
    geom_sf( aes(fill = month), color = NA) + 
    theme_void()  +
    scale_fill_viridis_d(option = "plasma", name = "Month")
}
```

::: {.panel-tabset}
##### DOP
```{r}
#| echo: false
#| fig-cap: Latest orthophoto coverage in Lower Saxony

plot_month(dop20)

summary(dop20$month)
```

##### bDOM
```{r}
#| echo: false
#| fig-cap: Latest coverage of image based height model in Lower Saxony

plot_month(bdom20)

summary(bdom20$month)
```
:::

#### Number of Images

```{r}
#| echo: true
#| code-fold: true
#| code-summary: "plot number of images"

# month of latest data per tile
plot_number <- function(dat){
  dat|>  
  st_drop_geometry() |>  # Work with data first
  group_by(tile_id) |> 
  summarise(n = n()) |> 
  left_join(dat|> select(tile_id) |> distinct(), by = "tile_id") |>
  st_as_sf() |>
  ggplot() + 
    geom_sf( aes(fill = as.factor(n)), color = NA) + 
    theme_void()  +
    scale_fill_viridis_d(option = "plasma", name = "# Campaigns")
}
```

::: {.panel-tabset}
##### DOP
```{r}
#| echo: false
#| fig-cap: Number of orthoimages per tile 

plot_number(dop20)
```

##### bDOM
```{r}
#| echo: false
#| fig-cap: Number of image based height models per tile 

plot_number(bdom20)
```
:::