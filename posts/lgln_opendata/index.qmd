---
title: Orthophoto coverage in Lower Saxony

#subtitle: 

description: |
  Get information about the coverage of LGLN orthophotos by date

abstract: | 
  Orthoimagery in Lower Saxony is acquired by LGLN and distributed via STAC as COGs, here we access and plot basic metadata via R. 

categories:
  - COG
  - Orthoimagery
  - Open Source
  - Raster Data
  - R

date: 2023-03-01
date-modified: last-modified
## `today` and `last-modified` will be rendered by quarto (e.g. date: today)

## author optional, default for all is set in metadata.yml
# author:
#  - name: Jens Wiesehahn
#    id: jw
#    orcid: 
#    email: wiesehahn.jens@gmail.com
## (https://quarto.org/docs/authoring/front-matter.html#affiliation)
#    affiliation: 
#      - name: NW-FVA
#        city: GÃ¶ttingen
#        # state:
#        # url: 

site-url: https://wiesehahn.github.io/

image: ortho_coverage_by_month.jpeg
image-alt: |
  Orthoimage coverage by month

# copyright: 
#   holder: Wiesehahn, Jens
#   year: 2023

# toc: false

draft: false
---

<!--------------- post content ----------------->

## About LGLN opendata

The State Office for Geoinformation and Land Surveying Lower Saxony (LGLN) provides a lot of its geodata as open data. And since some years they provide orthoimages as well as terrain models of Lower Saxony as Cloud Optimized GeoTIFFs (COG) and reference them via Spatio Temporal Asset Catalogs (STAC). 
Here we access the data via R to explore it's coverage by acquisition date.

More information about the data under [opengeodata.lgln.niedersachsen.de](https://opengeodata.lgln.niedersachsen.de/#dop).


## Working with Orthoimagery

### Initialize metadata catalog

The index of available data is available as a geojson file which is stored in a cloud bucket. It consists of many polygons which cover Lower Saxony and represent image tiles (2x2 km). For each tile it contains some basic metadata and links to further metadata of the images and links to the image data itself.

```{r}
#| echo: true
#| warning: false
#| message: false
#| error: false
#| code-fold: true
#| code-summary: "load libraries"
library(dplyr)
library(sf)
library(ggplot2)
```

```{r}
#| echo: true
#| code-fold: true
#| code-summary: "get data"

# read geojson from cloud bucket
dat <- st_read("https://arcgis-geojson.s3.eu-de.cloud-object-storage.appdomain.cloud/dop20/lgln-opengeodata-dop20.geojson")

# modify date
dat <- dat |> 
  mutate(
    date = lubridate::ymd(Aktualitaet),
    year = lubridate::year(date),
    month = lubridate::month(date, label = TRUE),
    doy = lubridate::yday(date)
  )
```


### Plot metadata catalog

The data catalog contains information about the acquisition date of images. We can plot this data to get more information about the available images.

#### Timespan
```{r}
#| echo: true
#| code-fold: true
#| code-summary: "get min/max date"

# first and last available acquisition dates
min <- dat |> arrange(date) |>  slice(1) |> pull(date)

max <- dat |> arrange(desc(date)) |>  slice(1) |> pull(date)

print(paste(min, " - ", max))
```


#### Most recent coverage

```{r}
#| echo: true
#| code-fold: true
#| code-summary: "plot latest data"
#| fig-cap: Most recent available orthophoto coverage in Lower Saxony

# latest acquisition date per tile
dat |> 
  group_by(tile_id) |> 
  slice_max(date, n = 1) |> 
  ggplot() + 
    geom_sf(aes(fill = as.factor(year)), color = NA) + 
    theme_void()  +
    scale_fill_viridis_d(option = "plasma")
```

#### First coverage

```{r}
#| echo: true
#| code-fold: true
#| code-summary: "plot first data"
#| fig-cap: First available orthophoto coverage in Lower Saxony

# first acquisition date per tile
dat |> 
  group_by(tile_id) |> 
  slice_min(date, n = 1) |> 
  ggplot() + 
    geom_sf(aes(fill = as.factor(year)), color = NA) + 
    theme_void()  +
    scale_fill_viridis_d(option = "plasma")
```


#### Leaf-off coverage

```{r}
#| echo: true
#| code-fold: true
#| code-summary: "plot leaf-off data"
#| fig-cap: Available orthophoto coverage in Lower Saxony during leaf-off season (Nov - Mar)

# latest leaf-off data per tile
dat |>  
  filter(month %in% c("Nov", "Dez", "Jan", "Feb", "Mrz")) |> 
  arrange(date) |> 
  ggplot() + 
    geom_sf( aes(fill = as.factor(year)), color = NA) + 
    theme_void()  +
    scale_fill_viridis_d(option = "plasma")
```

#### Leaf-on coverage

```{r}
#| echo: true
#| code-fold: true
#| code-summary: "plot leaf-on data"
#| fig-cap: Available orthophoto coverage in Lower Saxony during leaf-on season (Apr - Oct)

# latest leaf-on data per tile
dat |>  
  filter(month %in% c("Apr", "Mai", "Jun", "Jul", "Aug", "Sep", "Okt")) |> 
  arrange(date) |> 
  ggplot() + 
    geom_sf( aes(fill = as.factor(year)), color = NA) + 
    theme_void()  +
    scale_fill_viridis_d(option = "plasma")
```

#### Acquisition month

```{r}
#| echo: true
#| code-fold: true
#| code-summary: "plot month"
#| fig-cap: Latest orthophoto coverage in Lower Saxony by month

# month of latest data per tile
dat |>  
  group_by(tile_id) |> 
  slice_max(date, n = 1) |> 
  ggplot() + 
    geom_sf( aes(fill = month), color = NA) + 
    theme_void()  +
    scale_fill_viridis_d(option = "plasma")
```

#### Number of Images

```{r}
#| echo: true
#| code-fold: true
#| code-summary: "plot number of images"
#| fig-cap: Number of orthoimages per tile 

# month of latest data per tile
dat |>  
  st_drop_geometry() |>  # Work with data first
  group_by(tile_id) |> 
  summarise(n = n()) |> 
  left_join(dat |> select(tile_id) |> distinct(), by = "tile_id") |>
  st_as_sf() |>
  ggplot() + 
    geom_sf( aes(fill = as.factor(n)), color = NA) + 
    theme_void()  +
    scale_fill_viridis_d(option = "plasma")
```
