---
title: Temporal Patterns in LGLN Opendata

#subtitle: 

description: |
  Get information about the coverage and timing of LGLN products (othophotos / image-based height models / ALS-based height models)

abstract: | 
  Orthoimagery and airborne laser scanning data in Lower Saxony is acquired on a regular basis by LGLN, for many applications the acquisition date is important. We use R to query and plot this information for orthophotos, image-based height models and ALS-based height models. 

categories:
  - COG
  - Orthoimagery
  - Open Source
  - Raster Data
  - R
  - Lidar
  - Laserscanning

date: 2023-03-01
date-modified: last-modified
## `today` and `last-modified` will be rendered by quarto (e.g. date: today)

## author optional, default for all is set in metadata.yml
# author:
#  - name: Jens Wiesehahn
#    id: jw
#    orcid: 
#    email: wiesehahn.jens@gmail.com
## (https://quarto.org/docs/authoring/front-matter.html#affiliation)
#    affiliation: 
#      - name: NW-FVA
#        city: Göttingen
#        # state:
#        # url: 

site-url: https://wiesehahn.github.io/

image: ortho_coverage_by_month.jpeg
image-alt: |
  Orthoimage coverage by month

# copyright: 
#   holder: Wiesehahn, Jens
#   year: 2023

# toc: false

draft: false
---

<!--------------- post content ----------------->

## About LGLN opendata

The State Office for Geoinformation and Land Surveying Lower Saxony ([LGLN](https://www.lgln.niedersachsen.de/startseite/)) provides a lot of its geospatial datasets under open licences. These include orthoimages (DOP), image-based surface height models (bDOM), as well as terrain (DGM) and surface (DOM) models derived from airborne laser scanning (ALS). In recent years the data has been made available as Cloud Optimized GeoTIFFs (COG) and referenced through [SpatioTemporal Asset Catalogs (STAC)](https://stacspec.org/en). 

We use R to access and explore the acquisition dates of these datasets. The index of available data - stored as a GeoJSON file in a cloud bucket - contains numerous polygons representing image tiles (1 km² or 2 km²) covering Lower Saxony. Each tile contains some basic metadata and links to further metadata as well as links to the image data itself. 
We fetch the index files for orthoimages ([DOP](https://ni-lgln-opengeodata.hub.arcgis.com/apps/lgln-opengeodata::digitales-orthophoto-dop/about)), image-based height models ([bDOM](https://ni-lgln-opengeodata.hub.arcgis.com/apps/lgln-opengeodata::bildbasiertes-digitales-oberfl%C3%A4chenmodell-bdom20/about)) and ALS-based height models ([DGM](https://ni-lgln-opengeodata.hub.arcgis.com/apps/lgln-opengeodata::digitales-gel%C3%A4ndemodell-dgm1/about)/[DOM](https://ni-lgln-opengeodata.hub.arcgis.com/apps/lgln-opengeodata::digitales-oberfl%C3%A4chenmodell-dom1/about)) to examine acquisition timing.

More information about the data is available at [opengeodata.lgln.niedersachsen.de](https://opengeodata.lgln.niedersachsen.de/#dop).

## Data Acquisition Timing

Due to phenological effects there are different demands to the data in vegetated areas. 
For orthophotos, data collection during the leaf-on season is preferred to get information from tree canopy such as vitality and to get better results during image-matching for height model processing.
In contrast, terrain models derived from ALS data benefit from leaf-off conditions, when more laser pulses can penetrate the canopy and reach the ground surface.

DOP and bDOM originate from the same underlying imagery, but the available tiles and acquisition dates may differ because bDOM is generated only for a subset of images. Similarly, DGM and DOM are both derived from ALS data, but since they share the same acquisition basis, we only plot information for DGM, which can be considered representative of DOM as well.

::: {.callout-note}
The data is also indexed in as STAC which allows for advanced searching, filtering and processing.
It can be e.g. explored via [Radiant Earth STAC-Browser](https://radiantearth.github.io/stac-browser/#/external/dop.stac.lgln.niedersachsen.de/collections/DOP).
:::


```{r}
#| echo: true
#| warning: false
#| message: false
#| error: false
#| code-fold: true
#| code-summary: "load libraries"
library(dplyr)
library(sf)
library(ggplot2)
```

```{r}
#| echo: true
#| code-fold: true
#| code-summary: "get data"

# read geojson from cloud bucket
get_data <- function(geojson){
  dat <- st_read(geojson) |> 
  # modify date
  mutate(
    date = lubridate::ymd(Aktualitaet),
    year = lubridate::year(date),
    month = lubridate::month(date, label = TRUE),
    doy = lubridate::yday(date)
  )
  return(dat)
}

dop20<- get_data("https://arcgis-geojson.s3.eu-de.cloud-object-storage.appdomain.cloud/dop20/lgln-opengeodata-dop20.geojson")
bdom20<- get_data("https://arcgis-geojson.s3.eu-de.cloud-object-storage.appdomain.cloud/bdom20/lgln-opengeodata-bdom20.geojson")
dgm1<- get_data("https://arcgis-geojson.s3.eu-de.cloud-object-storage.appdomain.cloud/dgm1/lgln-opengeodata-dgm1.geojson")
```


### Plot coverage by acquisitioin dates

The data catalog contains information about the acquisition date of images. We can plot this data to get more information about the available images. Acquisition dates for bDOM should be in principle the same as for DOP as the underlying image data is the same, however not all images were processed to bDOM as the necessary data quality (overlap) has not always been fulfilled.

#### Overview about acquisition dates
```{r}
#| echo: true
#| code-fold: true
#| code-summary: "get overview"

# first and last available acquisition dates
get_timespan <- function(dat){
  min <- dat|> arrange(date) |>  slice(1) |> pull(date)
  max <- dat|> arrange(desc(date)) |>  slice(1) |> pull(date)
  
  cat("Images available from", format(min), "to", format(max), "\n")
}

plot_distribution <- function(dat){
  dat |> 
  ggplot(aes(x = doy)) +
  geom_bar() +
  scale_x_continuous(
    breaks = c(1, 32, 60, 91, 121, 152, 182, 213, 244, 274, 305, 335),
    labels = month.abb,
    limits = c(1, 365)
  ) +
  labs(x = NULL, y = NULL) +
  theme_void() +
  theme(
    axis.text.x = element_text(),
    legend.position = "top"
  )
}

```

::: {.panel-tabset}
##### DOP
```{r}
#| echo: false
#| warning: false
#| fig-cap: Distribution of orthophoto acquisitions in Lower Saxony by Day of Year

get_timespan(dop20)

plot_distribution(dop20)
```

##### bDOM
```{r}
#| echo: false
#| fig-cap: Distribution of orthophoto acquisitions for height models in Lower Saxony by Day of Year

get_timespan(bdom20)

plot_distribution(bdom20)
```

##### DGM
```{r}
#| echo: false
#| fig-cap: Distribution of DGM/DOM data in Lower Saxony by Day of Year

get_timespan(dgm1)

plot_distribution(dgm1)
```
:::

#### Most recent coverage
```{r}
#| echo: true
#| code-fold: true
#| code-summary: "plot latest data"

# latest acquisition date per tile
plot_latest <- function(dat){
  dat|> 
  group_by(tile_id) |> 
  slice_max(date, n = 1) |> 
  ggplot() + 
    geom_sf(aes(fill = as.factor(year)), color = NA) + 
    theme_void()  +
    scale_fill_viridis_d(option = "plasma", name = "Year")
}
```

::: {.panel-tabset}
##### DOP
```{r}
#| echo: false
#| fig-cap: Most recent available orthophoto coverage in Lower Saxony

plot_latest(dop20)
```

##### bDOM
```{r}
#| echo: false
#| fig-cap: Most recent available image based height model coverage in Lower Saxony

plot_latest(bdom20)
```

##### DGM
```{r}
#| echo: false
#| fig-cap: Most recent available DGM/DOM data coverage in Lower Saxony

plot_latest(dgm1)
```
:::


#### First coverage

```{r}
#| echo: true
#| code-fold: true
#| code-summary: "plot first data"


# first acquisition date per tile
plot_first <- function(dat){
  dat|> 
  group_by(tile_id) |> 
  slice_min(date, n = 1) |> 
  ggplot() + 
    geom_sf(aes(fill = as.factor(year)), color = NA) + 
    theme_void()  +
    scale_fill_viridis_d(option = "plasma", name = "Year")
}
```

::: {.panel-tabset}
##### DOP
```{r}
#| echo: false
#| fig-cap: First available orthophoto coverage in Lower Saxony

plot_first(dop20)
```

##### bDOM
```{r}
#| echo: false
#| fig-cap: First available coverage of image based height model in Lower Saxony

plot_first(bdom20)
```

##### DGM
```{r}
#| echo: false
#| fig-cap: First available DGM/DOM data in Lower Saxony

plot_first(dgm1)
```
:::


#### Leaf-off coverage

```{r}
#| echo: true
#| code-fold: true
#| code-summary: "plot leaf-off data"

# latest leaf-off data per tile
plot_leafoff <- function(dat){
  dat|>  
  mutate(Year = if_else(!between(doy, 115, 315), 
                        as.character(year), 
                        NA_character_)) |> 
  arrange(!is.na(Year), date) |> 
  ggplot() + 
    geom_sf(aes(fill = Year), color = NA) + 
    theme_void() +
    scale_fill_viridis_d(option = "plasma", na.value = "#f2f2f2", name = "Year")
}

```

::: {.panel-tabset}
##### DOP
```{r}
#| echo: false
#| fig-cap: Available orthophoto coverage in Lower Saxony during leaf-off season (mid November - mid April)

plot_leafoff(dop20)
```

##### bDOM
```{r}
#| echo: false
#| fig-cap: Available coverage of image based height model in Lower Saxony during leaf-off season (mid November - mid April)

plot_leafoff(bdom20)
```

##### DGM
```{r}
#| echo: false
#| fig-cap: Available coverage of DGM/DOM data in Lower Saxony during leaf-off season (mid November - mid April)

plot_leafoff(dgm1)
```
:::

#### Leaf-on coverage

```{r}
#| echo: true
#| code-fold: true
#| code-summary: "plot leaf-on data"

# latest leaf-on data per tile
plot_leafon <- function(dat){
  dat|>
  mutate(Year = if_else(between(doy, 115, 315), 
                        as.character(year), 
                        NA_character_)) |> 
  arrange(!is.na(Year), date) |> 
  ggplot() + 
    geom_sf(aes(fill = Year), color = NA) + 
    theme_void() +
    scale_fill_viridis_d(option = "plasma", na.value = "#f2f2f2", name = "Year")
}

```

::: {.panel-tabset}
##### DOP
```{r}
#| echo: false
#| fig-cap: Available orthophoto coverage in Lower Saxony during leaf-on season (mid April - mid November)

plot_leafon(dop20)
```

##### bDOM
```{r}
#| echo: false
#| fig-cap: Available coverage of image based height model in Lower Saxony during leaf-on season (mid April - mid November)

plot_leafon(bdom20)
```

##### DGM
```{r}
#| echo: false
#| fig-cap: Available coverage of DGM/DOM data in Lower Saxony during leaf-on season (mid April - mid November)

plot_leafon(dgm1)
```
:::

#### Acquisition month

```{r}
#| echo: true
#| code-fold: true
#| code-summary: "plot month"

# month of latest data per tile
plot_month <- function(dat){
  dat|>  
  group_by(tile_id) |> 
  slice_max(date, n = 1) |> 
  ggplot() + 
    geom_sf( aes(fill = month), color = NA) + 
    theme_void()  +
    scale_fill_viridis_d(option = "plasma", name = "Month")
}
```

::: {.panel-tabset}
##### DOP
```{r}
#| echo: false
#| fig-cap: Latest orthophoto coverage in Lower Saxony

plot_month(dop20)

summary(dop20$month)
```

##### bDOM
```{r}
#| echo: false
#| fig-cap: Latest coverage of image based height model in Lower Saxony

plot_month(bdom20)

summary(bdom20$month)
```

##### DGM
```{r}
#| echo: false
#| fig-cap: Latest coverage DGM/DOM data in Lower Saxony

plot_month(dgm1)

summary(dgm1$month)
```
:::


#### Number of Images

```{r}
#| echo: true
#| code-fold: true
#| code-summary: "plot number of images"

# month of latest data per tile
plot_number <- function(dat){
  dat|>  
  st_drop_geometry() |>  # Work with data first
  group_by(tile_id) |> 
  summarise(n = n()) |> 
  left_join(dat|> select(tile_id) |> distinct(), by = "tile_id") |>
  st_as_sf() |>
  ggplot() + 
    geom_sf( aes(fill = as.factor(n)), color = NA) + 
    theme_void()  +
    scale_fill_viridis_d(option = "plasma", name = "# Campaigns")
}
```

::: {.panel-tabset}
##### DOP
```{r}
#| echo: false
#| fig-cap: Number of orthoimages per tile 

plot_number(dop20)
```

##### bDOM
```{r}
#| echo: false
#| fig-cap: Number of image based height models per tile 

plot_number(bdom20)
```

##### DGM
```{r}
#| echo: false
#| fig-cap: Number of DGM/DOM acquisitions per tile 

plot_number(dgm1)
```
:::